<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pika Intermittent Timer ‚Äî Rounds Mode (Lucky Pikas)</title>
<style>
  :root{
    --bg:#0f1720; --panel:#111827; --accent:#ffb86b; --muted:#9aa4b2;
    --btn:#1f2937; --btn-hover:#2563eb; --success:#00c853; --danger:#ff5252;
    --glass: rgba(255,255,255,0.03);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071018);color:#e6eef6}
  .wrap{max-width:960px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{font-weight:800;color:var(--accent);font-size:20px}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:14px}
  @media(max-width:880px){.grid{grid-template-columns:1fr;}}
  .panel{background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.45)}
  .display{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);min-height:180px}
  .bigtime{font-size:44px;font-weight:700;letter-spacing:1px}
  .small{color:var(--muted);font-size:13px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
  .btn{background:var(--btn);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--btn-hover)}
  .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .btn.warn{background:var(--danger)}
  .btn.success{background:var(--success);color:#051219}
  .row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  .num{font-size:16px;padding:6px 10px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .settingsList{display:flex;flex-direction:column;gap:8px}
  .controlCol{display:flex;flex-direction:column;gap:6px}
  .smallBtn{padding:8px;border-radius:8px;background:var(--btn);border:0;color:#fff;cursor:pointer}
  .footerNote{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
  .clockView{font-weight:700;font-size:14px;color:var(--muted)}
  .inputRow{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  .icon{font-size:18px}
  select, input[type="number"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .toggle{display:flex;gap:6px;align-items:center}
  .helpLink{color:var(--accent);text-decoration:none;font-weight:700}
  @media(max-width:520px){ .bigtime{font-size:34px} .panel{padding:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">‚ö° Pika Intermittent Timer</div>
        <div class="subtitle">Rounds mode, vibration & accurate timing ‚Äî Lucky Pikas</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="clockView" id="live-clock">Loading time‚Ä¶</div>
        <div class="small" id="live-date">‚Äî</div>
      </div>
    </header>

    <div class="grid">
      <!-- Main panel -->
      <div class="panel">
        <div class="display" id="display">
          <div class="small" id="modeLabel">Mode: <strong id="modeText">Timer</strong></div>
          <div class="bigtime" id="mainTime">00:00:00</div>
          <div class="small" id="statusText">Set a mode, rounds or total time & interval, then press GO.</div>

          <div class="controls">
            <div class="controlCol" style="min-width:260px">
              <div class="label">Active (work) length</div>
              <div class="row">
                <button class="btn" id="activeUp">+1 min</button>
                <button class="btn" id="activeDown">-1 min</button>
                <div class="num" id="activeDisplay">03:00</div>
              </div>
            </div>

            <div class="controlCol" style="min-width:260px">
              <div class="label">Chill (rest) length</div>
              <div class="row">
                <button class="btn" id="restUp">+1 min</button>
                <button class="btn" id="restDown">-1 min</button>
                <div class="num" id="restDisplay">01:00</div>
              </div>
            </div>
          </div>

          <div class="controls" style="margin-top:10px">
            <div class="inputRow">
              <label style="font-size:13px;color:var(--muted);margin-right:6px">Rounds mode</label>
              <input type="checkbox" id="useRounds" checked>
              <label style="font-size:13px;color:var(--muted);margin-left:8px">Rounds</label>
              <input type="number" id="roundCount" min="1" value="5" style="width:80px;margin-left:6px">
              <div style="font-size:13px;color:var(--muted);margin-left:8px">Current: <span id="currentRound">0</span>/<span id="roundTotal">5</span></div>
            </div>
          </div>

          <div class="controls" style="margin-top:10px">
            <button class="btn success" id="goBtn">üî¥ GO</button>
            <button class="btn alt" id="pauseBtn">‚è∏ Pause</button>
            <button class="btn alt" id="resumeBtn" style="display:none">‚ñ∂ Resume</button>
            <button class="btn alt" id="stopBtn">‚èπ Stop</button>
            <button class="btn" id="clockToggle">‚è∞ Clock</button>
            <button class="btn" id="settingsBtn">‚öô Settings</button>
            <button class="btn alt" id="helpBtn">‚ùì Help</button>
          </div>

          <div class="footerNote">
            Rounds mode alternates Active ‚Üí Chill exactly as in boxing. Vibration supported on compatible devices.
          </div>
        </div>
      </div>

      <!-- Side panel -->
      <div class="panel" id="sidePanel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Settings</div>
          <div style="font-size:13px;color:var(--muted)">Saved locally</div>
        </div>

        <div class="settingsList">
          <div>
            <div class="label">Notification Sound</div>
            <select id="soundSelect" aria-label="notification sound">
              <option value="dingding">Ding Ding</option>
              <option value="ding">Ding</option>
              <option value="bop">Bop</option>
              <option value="chime">Chime</option>
              <option value="bell">Bell</option>
              <option value="tone">Tone</option>
              <option value="none">None</option>
            </select>
          </div>

          <div>
            <div class="label">Vibrate on phase change</div>
            <div class="toggle">
              <label style="font-size:13px;color:var(--muted)"><input type="checkbox" id="vibrateToggle" checked> Enabled</label>
            </div>
          </div>

          <div>
            <div class="label">Auto notifications (browser)</div>
            <div class="toggle">
              <button class="smallBtn" id="notifyPermBtn">Request Permission</button>
              <div style="color:var(--muted);font-size:13px" id="notifyStatus">Not requested</div>
            </div>
          </div>

          <div>
            <div class="label">Audio volume</div>
            <input type="range" id="volume" min="0" max="1" step="0.05" value="0.9">
          </div>

          <div>
            <div class="label">Presets (quick load)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="smallBtn" id="presetBox">3/1 x5</button>
              <button class="smallBtn" id="presetHIIT">0.5/0.2 x20</button>
              <button class="smallBtn" id="presetYoga">15/5 x2</button>
            </div>
          </div>

        </div>

        <div style="margin-top:12px;font-size:13px;color:var(--muted)">
          Tip: If you prefer a total duration instead of rounds, uncheck Rounds mode ‚Äî the timer will then use Total-Time counting.
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn alt" id="importBtn">Import</button>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:16px;color:var(--muted);font-size:13px">
      <a class="helpLink" href="https://luckypikas.blogspot.com/p/pika-yoga-timer-help-faqs-lucky-pikas.html" target="_blank">Pika Timer Help & FAQs</a>
    </div>
  </div>

<script>
/* Pika Intermittent Timer ‚Äî Rounds Mode + Vibration
   - Active (work) seconds and Chill (rest) seconds
   - Rounds mode: run N rounds of Active->Chill
   - Vibration on phase change (navigator.vibrate)
   - Accurate Date.now() timing
*/

(() => {
  // helpers
  const $ = sel => document.querySelector(sel);
  const pad = n => String(n).padStart(2,'0');
  const fmtHMS = s => {
    s = Math.max(0, Math.floor(s));
    const hh = pad(Math.floor(s/3600));
    const mm = pad(Math.floor((s%3600)/60));
    const ss = pad(s%60);
    return `${hh}:${mm}:${ss}`;
  };
  const fmtMS = s => {
    s = Math.max(0, Math.floor(s));
    const mm = pad(Math.floor(s/60));
    const ss = pad(s%60);
    return `${mm}:${ss}`;
  };

  // DOM
  const mainTime = $('#mainTime'), modeText = $('#modeText'), statusText = $('#statusText');
  const activeDisplay = $('#activeDisplay'), restDisplay = $('#restDisplay');
  const activeUp = $('#activeUp'), activeDown = $('#activeDown'), restUp = $('#restUp'), restDown = $('#restDown');
  const goBtn = $('#goBtn'), pauseBtn = $('#pauseBtn'), resumeBtn = $('#resumeBtn'), stopBtn = $('#stopBtn'), clockToggle = $('#clockToggle'), helpBtn = $('#helpBtn');
  const useRounds = $('#useRounds'), roundCount = $('#roundCount'), currentRound = $('#currentRound'), roundTotal = $('#roundTotal');
  const soundSelect = $('#soundSelect'), volumeEl = $('#volume'), vibrateToggle = $('#vibrateToggle');
  const notifyPermBtn = $('#notifyPermBtn'), notifyStatus = $('#notifyStatus');

  // preset buttons
  const presetBox = $('#presetBox'), presetHIIT = $('#presetHIIT'), presetYoga = $('#presetYoga');

  // state
  let activeSeconds = 180;  // default 3:00
  let restSeconds = 60;     // default 1:00
  const INTERVAL_MAX = 20*60;
  let roundsTotal = parseInt(roundCount.value || 5, 10);
  let roundsCurrent = 0;
  let running = false;
  let paused = false;
  let phase = 'idle'; // 'active','rest','idle'
  let phaseEndAt = 0; // ms timestamp when current phase ends
  let remainingPhaseSeconds = 0;
  let intervalId = null;

  // audio (WebAudio)
  const audioCtx = (function(){ try{ return new (window.AudioContext||window.webkitAudioContext)(); }catch(e){return null}})();
  let masterGain = null;
  if(audioCtx) { masterGain = audioCtx.createGain(); masterGain.gain.value = parseFloat(volumeEl.value||0.9); masterGain.connect(audioCtx.destination); }

  // vibration
  const vibrate = (pattern) => {
    if('vibrate' in navigator && vibrateToggle.checked) {
      try { navigator.vibrate(pattern); } catch(e){}
    }
  };

  // play tone wrapper
  function playTone(kind){
    if(!audioCtx) return;
    const now = audioCtx.currentTime;
    const g = masterGain;
    const osc = audioCtx.createOscillator();
    const env = audioCtx.createGain();
    osc.connect(env); env.connect(g);
    switch(kind){
      case 'start': osc.type='sine'; osc.frequency.value=880; env.gain.setValueAtTime(0, now); env.gain.linearRampToValueAtTime(0.8, now+0.01); env.gain.exponentialRampToValueAtTime(0.001, now+0.6); osc.start(now); osc.stop(now+0.65); break;
      case 'ding': osc.type='sine'; osc.frequency.value=880; env.gain.setValueAtTime(0, now); env.gain.linearRampToValueAtTime(1, now+0.01); env.gain.exponentialRampToValueAtTime(0.001, now+0.5); osc.start(now); osc.stop(now+0.55); break;
      case 'bop': osc.type='square'; osc.frequency.value=440; env.gain.setValueAtTime(0, now); env.gain.linearRampToValueAtTime(0.9, now+0.01); env.gain.exponentialRampToValueAtTime(0.001, now+0.25); osc.start(now); osc.stop(now+0.26); break;
      case 'dingding':
        // two shorter beeps
        const o1 = audioCtx.createOscillator(), e1 = audioCtx.createGain();
        o1.connect(e1); e1.connect(g); o1.type='sine'; o1.frequency.value=880;
        e1.gain.setValueAtTime(0, now); e1.gain.linearRampToValueAtTime(1, now+0.01); e1.gain.exponentialRampToValueAtTime(0.001, now+0.2);
        o1.start(now); o1.stop(now+0.22);
        const o2 = audioCtx.createOscillator(), e2 = audioCtx.createGain();
        o2.connect(e2); e2.connect(g); o2.type='sine'; o2.frequency.value=880;
        e2.gain.setValueAtTime(0, now+0.26); e2.gain.linearRampToValueAtTime(1, now+0.27); e2.gain.exponentialRampToValueAtTime(0.001, now+0.47);
        o2.start(now+0.26); o2.stop(now+0.48);
        break;
      default:
        osc.type='sine'; osc.frequency.value=600; env.gain.setValueAtTime(0, now); env.gain.linearRampToValueAtTime(0.7, now+0.01); env.gain.exponentialRampToValueAtTime(0.001, now+0.4); osc.start(now); osc.stop(now+0.45);
    }
  }

  // browser notifications
  async function requestNotificationPermission(){
    if(!('Notification' in window)) { notifyStatus.textContent = 'Not supported'; return; }
    try { const p = await Notification.requestPermission(); notifyStatus.textContent = p; } catch(e){ notifyStatus.textContent = 'error'; }
  }
  notifyPermBtn.addEventListener('click', requestNotificationPermission);

  function showBrowserNotification(title, body){
    if('Notification' in window && Notification.permission === 'granted') {
      try { const n = new Notification(title, {body, tag:'pika-rounds'}); setTimeout(()=>n.close(), 4000); } catch(e){}
    }
  }

  // UI updates
  function refreshUI(){
    activeDisplay.textContent = fmtMS(activeSeconds);
    restDisplay.textContent = fmtMS(restSeconds);
    roundTotal.textContent = roundsTotal;
    currentRound.textContent = roundsCurrent;
    if(phase === 'idle'){
      modeText.textContent = useRounds.checked ? 'Rounds (idle)' : 'Timer (idle)';
      mainTime.textContent = fmtHMS(activeSeconds + restSeconds * (useRounds.checked ? 0 : 0));
      statusText.textContent = 'Ready. Set rounds & times then press GO.';
    } else if(phase === 'active'){
      modeText.textContent = 'Active';
      mainTime.textContent = fmtMS(Math.max(0,remainingPhaseSeconds));
      statusText.textContent = `Round ${roundsCurrent}/${roundsTotal} ‚Äî Active`;
    } else if(phase === 'rest'){
      modeText.textContent = 'Chill (rest)';
      mainTime.textContent = fmtMS(Math.max(0,remainingPhaseSeconds));
      statusText.textContent = `Round ${roundsCurrent}/${roundsTotal} ‚Äî Rest`;
    }
  }

  // timing utilities
  let lastNow = 0;
  function startLoop(){
    if(intervalId) clearInterval(intervalId);
    lastNow = Date.now();
    intervalId = setInterval(loopTick, 200);
  }
  function stopLoop(){ if(intervalId) clearInterval(intervalId); intervalId = null; }

  function loopTick(){
    if(!running || paused) return;
    const now = Date.now();
    // recalc remainingPhaseSeconds using phaseEndAt
    remainingPhaseSeconds = Math.max(0, Math.round((phaseEndAt - now)/1000));
    if(now >= phaseEndAt){
      // end of phase: transition
      if(phase === 'active'){
        // active ended -> start rest (if restSeconds>0) else count round complete and possibly start next active
        if(restSeconds > 0){
          phase = 'rest';
          phaseEndAt = Date.now() + restSeconds * 1000;
          remainingPhaseSeconds = restSeconds;
          // notify
          doPhaseActions('rest');
        } else {
          // immediate round completion
          roundsCurrent++;
          if(roundsCurrent >= roundsTotal){
            finishAll();
            return;
          } else {
            // start next active
            phase = 'active';
            phaseEndAt = Date.now() + activeSeconds * 1000;
            remainingPhaseSeconds = activeSeconds;
            doPhaseActions('active');
          }
        }
      } else if(phase === 'rest'){
        // rest ended -> increment round and either finish or start next active
        roundsCurrent++;
        if(roundsCurrent >= roundsTotal){
          finishAll();
          return;
        } else {
          phase = 'active';
          phaseEndAt = Date.now() + activeSeconds * 1000;
          remainingPhaseSeconds = activeSeconds;
          doPhaseActions('active');
        }
      }
    }
    refreshUI();
  }

  function doPhaseActions(phaseName){
    // play sound according to selected sound
    const s = soundSelect.value || 'dingding';
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    // map user selection to our playTone events (keeps it simple)
    // we'll always call playTone with a generic type (start/ding/bop/dingding)
    if(phaseName === 'active'){
      // sound + vibrate
      if(s === 'dingding') playTone('dingding'); else if(s === 'bop') playTone('bop'); else if(s==='none'){} else playTone('ding');
      if(vibrateToggle.checked) vibrate([120,60,120]);
      showBrowserNotification('Active start', `Round ${roundsCurrent}/${roundsTotal}`);
    } else if(phaseName === 'rest'){
      if(s === 'bop') playTone('bop'); else if(s === 'none'){} else playTone('ding');
      if(vibrateToggle.checked) vibrate([80]);
      showBrowserNotification('Rest start', `Take ${fmtMS(restSeconds)} to recover`);
    }
  }

  // start/stop/pause/resume
  function startRounds(){
    // require sensible values
    roundsTotal = Math.max(1, parseInt(roundCount.value || 1, 10));
    roundTotal.textContent = roundsTotal;
    if(useRounds.checked){
      // rounds mode
      roundsCurrent = 1;
      phase = 'active';
      phaseEndAt = Date.now() + activeSeconds * 1000;
      remainingPhaseSeconds = activeSeconds;
      running = true; paused = false;
      // initial actions
      doPhaseActions('active');
      startLoop();
      refreshUI();
    } else {
      // non-rounds: fallback to single long total timer (not rounds). We'll run Active as total and no rest.
      roundsCurrent = 0;
      phase = 'active';
      phaseEndAt = Date.now() + activeSeconds * 1000; // treat activeSeconds as total in this mode
      remainingPhaseSeconds = activeSeconds;
      running = true; paused = false;
      doPhaseActions('active');
      startLoop();
      refreshUI();
    }
    // UI states
    pauseBtn.style.display = 'inline-block';
    resumeBtn.style.display = 'none';
  }

  function pauseTimer(){
    if(!running || paused) return;
    paused = true;
    // compute remainingPhaseSeconds now
    remainingPhaseSeconds = Math.max(0, Math.round((phaseEndAt - Date.now())/1000));
    // save paused state by setting phaseEndAt to now + remainingPhaseSeconds when resuming
    stopLoop();
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'inline-block';
    statusText.textContent = 'Paused';
  }

  function resumeTimer(){
    if(!running || !paused) return;
    paused = false;
    phaseEndAt = Date.now() + remainingPhaseSeconds*1000;
    startLoop();
    pauseBtn.style.display = 'inline-block';
    resumeBtn.style.display = 'none';
    statusText.textContent = 'Resumed';
  }

  function stopAll(){
    running = false; paused = false; phase='idle'; phaseEndAt = 0;
    stopLoop();
    roundsCurrent = 0;
    refreshUI();
    pauseBtn.style.display = 'inline-block';
    resumeBtn.style.display = 'none';
  }

  function finishAll(){
    // stop and signal completion
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    const s = soundSelect.value || 'dingding';
    if(s === 'dingding') playTone('dingding'); else if(s === 'bop') playTone('bop'); else if(s !== 'none') playTone('tone');
    if(vibrateToggle.checked) vibrate([250,80,250]);
    showBrowserNotification('Session complete', 'Well done ‚Äî all rounds finished');
    stopAll();
    statusText.textContent = 'Complete';
  }

  // control wiring
  activeUp.onclick = () => { activeSeconds = Math.min(activeSeconds + 60, 99*3600); refreshUI(); saveState(); };
  activeDown.onclick = () => { activeSeconds = Math.max(10, activeSeconds - 60); refreshUI(); saveState(); };
  restUp.onclick = () => { restSeconds = Math.min(restSeconds + 60, 20*60); refreshUI(); saveState(); };
  restDown.onclick = () => { restSeconds = Math.max(0, restSeconds - 60); refreshUI(); saveState(); };

  goBtn.onclick = () => {
    if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
    // quick validation: activeSeconds must be >0
    if(activeSeconds <= 0){ alert('Set an active (work) time > 0'); return; }
    if(useRounds.checked && (restSeconds < 0)) { alert('Invalid rest time'); return; }
    roundsTotal = Math.max(1, parseInt(roundCount.value || 1,10));
    startRounds();
    saveState();
  };
  pauseBtn.onclick = pauseTimer; resumeBtn.onclick = resumeTimer; stopBtn.onclick = stopAll;
  clockToggle.onclick = () => {
    // toggles clock overlay in main area; simpler: open new tab with time
    const win = window.open('', '_blank');
    win.document.write(`<pre style="font-size:24px;padding:40px;font-family:monospace">${new Date().toLocaleString()}</pre>`);
  };
  helpBtn.onclick = () => window.open('https://luckypikas.blogspot.com/p/pika-yoga-timer-help-faqs-lucky-pikas.html', '_blank');

  // presets
  presetBox.onclick = () => { activeSeconds = 180; restSeconds = 60; roundCount.value = 5; roundsTotal = 5; refreshUI(); saveState(); };
  presetHIIT.onclick = () => { activeSeconds = 30; restSeconds = 20; roundCount.value = 20; roundsTotal = 20; refreshUI(); saveState(); };
  presetYoga.onclick = () => { activeSeconds = 15*60; restSeconds = 5*60; roundCount.value = 2; roundsTotal = 2; refreshUI(); saveState(); };

  // save/load settings
  const LS_SETTINGS = 'pika_roundtimer_settings_v1';
  function saveState(){
    const s = {
      activeSeconds, restSeconds, roundsTotal: parseInt(roundCount.value||1,10), sound: soundSelect.value, volume: parseFloat(volumeEl.value), vibrate: vibrateToggle.checked, useRounds: useRounds.checked
    };
    try { localStorage.setItem(LS_SETTINGS, JSON.stringify(s)); } catch(e){}
    if(masterGain) masterGain.gain.value = parseFloat(volumeEl.value||0.9);
  }
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_SETTINGS) || '{}');
      if(s.activeSeconds) activeSeconds = s.activeSeconds;
      if(s.restSeconds) restSeconds = s.restSeconds;
      if(s.roundsTotal) roundCount.value = s.roundsTotal;
      if(s.sound) soundSelect.value = s.sound;
      if(s.volume !== undefined) volumeEl.value = s.volume;
      if(s.vibrate !== undefined) vibrateToggle.checked = s.vibrate;
      if(s.useRounds !== undefined) useRounds.checked = s.useRounds;
      roundsTotal = parseInt(roundCount.value||1,10);
    }catch(e){}
    if(masterGain) masterGain.gain.value = parseFloat(volumeEl.value||0.9);
  }
  loadState(); refreshUI();

  // export/import
  $('#exportBtn').onclick = () => {
    const data = JSON.stringify({activeSeconds,restSeconds,roundsTotal:parseInt(roundCount.value||1,10),sound:soundSelect.value,volume:volumeEl.value,vibrate:vibrateToggle.checked}, null, 2);
    const a = document.createElement('a'); const blob = new Blob([data], {type:'application/json'}); a.href = URL.createObjectURL(blob); a.download = 'pika-rounds-settings.json'; document.body.appendChild(a); a.click(); a.remove();
  };
  $('#importBtn').onclick = () => {
    const f = document.createElement('input'); f.type='file'; f.accept='.json'; f.onchange = () => {
      const file = f.files[0]; if(!file) return;
      const r = new FileReader(); r.onload = () => {
        try {
          const obj = JSON.parse(r.result);
          if(obj.activeSeconds) activeSeconds = obj.activeSeconds;
          if(obj.restSeconds) restSeconds = obj.restSeconds;
          if(obj.roundsTotal) roundCount.value = obj.roundsTotal;
          if(obj.sound) soundSelect.value = obj.sound;
          if(obj.volume !== undefined) volumeEl.value = obj.volume;
          if(obj.vibrate !== undefined) vibrateToggle.checked = obj.vibrate;
          saveState(); refreshUI();
          alert('Imported');
        } catch(e){ alert('Import failed'); }
      }; r.readAsText(file);
    }; f.click();
  };

  // keep UI in sync if user edits roundCount directly
  roundCount.addEventListener('change', () => { roundsTotal = Math.max(1, parseInt(roundCount.value||1,10)); saveState(); refreshUI(); });

  // volume control
  volumeEl.addEventListener('input', () => { if(masterGain) masterGain.gain.value = parseFloat(volumeEl.value||0.9); saveState(); });

  // sound selection change
  soundSelect.addEventListener('change', saveState);
  vibrateToggle.addEventListener('change', saveState);
  useRounds.addEventListener('change', saveState);

  // keyboard: space toggle
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); if(running && !paused) pauseTimer(); else if(running && paused) resumeTimer(); else goBtn.click(); }});

  // small clock updater for header
  const lc = $('#live-clock'), ld = $('#live-date');
  setInterval(()=>{ const now = new Date(); lc.textContent = now.toLocaleTimeString(); ld.textContent = now.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'}); }, 1000);

  // ensure AudioContext resumes on user interaction
  document.addEventListener('click', () => { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, {once:true});

  // when page unload save
  window.addEventListener('beforeunload', saveState);

  // convenience: expose debug API
  window.PikaRounds = { start: () => goBtn.click(), stop: stopAll, pause: pauseTimer, resume: resumeTimer, status: () => ({running, paused, phase, roundsCurrent, roundsTotal, activeSeconds, restSeconds}) };

})();
</script>
</body>
</html>
